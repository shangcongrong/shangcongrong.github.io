<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>AFei</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="AFei">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="AFei">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AFei">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="AFei" type="application/atom+xml">
  
  
    <link rel="icon" href="/afei.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/2649927?v=3&amp;u=8517cc7bbcbac2fea9b631e386b3dd32755b6eb0&amp;s=140" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Rodriguez-Xin</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/shangcongrong" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/rodriguezxin" title="zhihu">zhihu</a>
					        
								<a class="mail" target="_blank" href="/yangxin1545@163.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/fresco/" style="font-size: 10px;">fresco</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Rodriguez-Xin</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/2649927?v=3&amp;u=8517cc7bbcbac2fea9b631e386b3dd32755b6eb0&amp;s=140" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">Rodriguez-Xin</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/shangcongrong" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/rodriguezxin" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="/yangxin1545@163.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-2015-08-19" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/19/2015-08-19/" class="article-date">
  	<time datetime="2015-08-19T03:29:29.000Z" itemprop="datePublished">2015-08-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/19/2015-08-19/">Android图片加载框架Fresco分析(一)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>作为Android开发者，虽然不是大牛，但也接触了很多图片加载框架，因为手机上最难处理最占内存的往往也就是图片，如果图片处理不好，很容易引起程序崩溃。到目前为止我接触过很多种图片加载框架，其中主要有：UniversalImageLoader，Picasso，Glide，Fresco。<br>Fresco是Facebook最新推出的一款用于Android应用中展示图片的强大图片库，可以从网络、本地存储和本地资源中加载图片。其中的Drawees可以显示占位符，直到图片加载完成。而当图片从屏幕上消失时，会自动释放内存。由于目前项目中使用到了Fresco，所以针对Fresco做一下源码分析。</p>
<h3 id="1-功能介绍">1.功能介绍</h3><p>Fresco类似ImageLoader和Picasoo一样，操作起来都比较简单，几行代码就可以开始使用了。可以简单的在xml里使用<strong>SimpleDraweeView</strong>配置一些属性。在代码中使用<strong>SimpleDraweeView</strong>的<strong>setImageURI</strong>方法来进行图片的加载。</p>
<p>Fresco有很大的优点，Fresco的中文文档中说的就很明白，主要优点有：</p>
<blockquote>
<ol>
<li>能够通过Drawees模块让不再显示在屏幕上的图片及时地释放内存和空间。</li>
<li>能够渐进式加载图片。这也是其他图片加载控件所没有的功能。</li>
<li>支持加载Gif图，支持WebP格式</li>
<li>缩放或者旋转图片，圆形圆角图片等等</li>
</ol>
</blockquote>
<h3 id="2-总体设计">2.总体设计</h3><p>Fresco总体上也是MVC模式，但是其中包含了很多的设计模式，之后会慢慢叙述。在源代码中。</p>
<ul>
<li>DraweeView就相当于View层，负责图片展示以及各种loading，加载效果。</li>
<li>DraweeController负责接洽View层的展示，每一个view会有一个mDraweeHolder，holder将view中的各种除了展示的操作解耦出来，分而治之。holder中又包含一个controller。controller则负责与下一层hierarchy的连接操作。</li>
<li>DraweeHierarchy相当于M层，用于下载和转换等，维护最终绘制和呈现的Drawable对象。</li>
</ul>
<h3 id="3-Fresco简单使用">3.Fresco简单使用</h3><p>使用起来很简单，在Android Studio里面的build.gradle文件中配置好对fresco的引用。</p>
<pre><code><span class="keyword">dependencies</span> {
<span class="keyword">compile</span> <span class="string">'com.facebook.fresco:fresco:0.3.0+'</span>
}
</code></pre><p>之后要在Application类中进行初始化操作：</p>
<pre><code>Fresco.initialize(<span class="keyword">this</span>, FrescoConfig.getImagePipelineConfig(<span class="keyword">this</span>));
</code></pre><p>FrescoConfig中可以设置一些缓存空间大小，缓存图片地址，以及设置几级缓存。<strong>MemoryCacheParams</strong>可以对内存进行配置：</p>
<pre><code><span class="comment">//内存配置</span>
final MemoryCacheParams bitmapCacheParams = <span class="literal">new</span> MemoryCacheParams(
FrescoConfig<span class="built_in">.</span>MAX_MEMORY_CACHE_SIZE, <span class="comment">// 内存缓存中总图片的最大大小,以字节为单位。</span>
<span class="built_in">Integer</span><span class="built_in">.</span>MAX_VALUE,                     <span class="comment">// 内存缓存中图片的最大数量。</span>
FrescoConfig<span class="built_in">.</span>MAX_MEMORY_CACHE_SIZE, <span class="comment">// 内存缓存中准备清除但尚未被删除的总图片的最大大小,以字节为单位。</span>
<span class="built_in">Integer</span><span class="built_in">.</span>MAX_VALUE,                     <span class="comment">// 内存缓存中准备清除的总图片的最大数量。</span>
<span class="built_in">Integer</span><span class="built_in">.</span>MAX_VALUE);                    <span class="comment">// 内存缓存中单个图片的最大大小。</span>
</code></pre><p>要想使用刚才设置的内存缓存配置需要，使用得到一个Supplier才能设置成功。</p>
<pre><code><span class="comment">//修改内存图片缓存数量，空间策略（这个方式有点恶心）</span>
Supplier&lt;MemoryCacheParams&gt; mSupplierMemoryCacheParams = <span class="keyword">new</span> Supplier&lt;MemoryCacheParams&gt;() {
    <span class="annotation">@Override</span>
    <span class="keyword">public</span> <span class="function">MemoryCacheParams <span class="title">get</span><span class="params">()</span> </span>{
        <span class="keyword">return</span> bitmapCacheParams;
    }
};
</code></pre><p>还可以对小图片和默认图片进行磁盘的配置：</p>
<pre><code><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> IMAGE_PIPELINE_CACHE_DIR = <span class="string">"/rodriguez/image"</span>;<span class="comment">//默认图所放路径的文件夹名</span>
<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> MAX_DISK_CACHE_VERYLOW_SIZE = <span class="number">10</span> * ByteConstants.MB;<span class="comment">//默认图极低磁盘空间缓存的最大值</span>
<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> MAX_DISK_CACHE_LOW_SIZE = <span class="number">30</span> * ByteConstants.MB;<span class="comment">//默认图低磁盘空间缓存的最大值</span>
<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> MAX_DISK_CACHE_SIZE = <span class="number">50</span> * ByteConstants.MB;<span class="comment">//默认图磁盘缓存的最大值</span>
<span class="comment">//默认图片的磁盘配置</span>
DiskCacheConfig diskCacheConfig = DiskCacheConfig.newBuilder()
        .setBaseDirectoryPath(Environment.getExternalStorageDirectory().getAbsoluteFile())<span class="comment">//缓存图片基路径</span>
        .setBaseDirectoryName(IMAGE_PIPELINE_CACHE_DIR)<span class="comment">//文件夹名</span>
<span class="comment">//            .setCacheErrorLogger(cacheErrorLogger)//日志记录器用于日志错误的缓存。</span>
<span class="comment">//            .setCacheEventListener(cacheEventListener)//缓存事件侦听器。</span>
<span class="comment">//            .setDiskTrimmableRegistry(diskTrimmableRegistry)//类将包含一个注册表的缓存减少磁盘空间的环境。</span>
        .setMaxCacheSize(FrescoConfig.MAX_DISK_CACHE_SIZE)<span class="comment">//默认缓存的最大大小。</span>
        .setMaxCacheSizeOnLowDiskSpace(MAX_DISK_CACHE_LOW_SIZE)<span class="comment">//缓存的最大大小,使用设备时低磁盘空间。</span>
        .setMaxCacheSizeOnVeryLowDiskSpace(MAX_DISK_CACHE_VERYLOW_SIZE)<span class="comment">//缓存的最大大小,当设备极低磁盘空间</span>
<span class="comment">//            .setVersion(version)</span>
        .build();
</code></pre><p>最后一步便是将之前设置的config应用到Fresco中。需要使用到<strong>ImagePipelineConfig.Builder</strong>，builder中可以对很多属性进行配置，比如图片解码库，是否旋转图片，是否渐进式加载等等。需要的同学可以去官方文档中查询相关设置。</p>
<pre><code><span class="comment">//缓存图片配置</span>
ImagePipelineConfig.Builder configBuilder = ImagePipelineConfig.newBuilder<span class="params">(context)</span>
        .setBitmapMemoryCacheParamsSupplier<span class="params">(mSupplierMemoryCacheParams)</span><span class="comment">//内存缓存配置（一级缓存，已解码的图片）</span>
        .setMainDiskCacheConfig<span class="params">(diskCacheConfig)</span><span class="comment">//磁盘缓存配置（总，三级缓存）</span>
        .setSmallImageDiskCacheConfig<span class="params">(diskSmallCacheConfig)</span><span class="comment">//磁盘缓存配置（小图片，可选～三级缓存的小图优化缓存）</span>
        ;
</code></pre><p>然后将得到的builder设置到之前的initialize代码中，便可以应用。经过这番操作，初始化配置过程基本上算已经完成。</p>
<p>要使用Fresco加载图片。也是特别简单的。在xml文件中添加上相应的view，在设置一些需要的fresco参数。</p>
<pre><code>&lt;<span class="tag">com</span><span class="class">.facebook</span><span class="class">.drawee</span><span class="class">.view</span><span class="class">.SimpleDraweeView</span>
        <span class="rule"><span class="attribute">xmlns</span>:<span class="value">fresco=<span class="string">"http://schemas.android.com/apk/res-auto"</span>
        android:id=<span class="string">"@+id/goods_image"</span>
        android:layout_width=<span class="string">"match_parent"</span>
        android:layout_height=<span class="string">"wrap_content"</span>
        fresco:progressBarImage=<span class="string">"@drawable/loading_circle_gray"</span>
        fresco:progressBarAutoRotateInterval=<span class="string">"@integer/default_loading_duration"</span>
        fresco:failureImage=<span class="string">"@drawable/image_default_bg"</span>/&gt;</span></span>
</code></pre><p>记住一定要在当前view或者根view中添加<strong>xmlns:fresco…</strong>这句。当前代码中也只是简单的对loading view和错误图片做了设置。</p>
<p>之后便是最简单也最需要的加载图片了。</p>
<pre><code><span class="tag">imageView</span><span class="class">.setImageURI</span>(<span class="tag">imgUri</span>);
</code></pre><p>一句话就可以将操作交给Fresco，自己就可以做其他的事情了。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fresco/">fresco</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-自定义控件使用isInEditMode防止窗口泄漏" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/12/自定义控件使用isInEditMode防止窗口泄漏/" class="article-date">
  	<time datetime="2015-08-12T07:35:14.000Z" itemprop="datePublished">2015-08-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/12/自定义控件使用isInEditMode防止窗口泄漏/">自定义控件使用isInEditMode防止窗口泄漏</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在开发过程中有时候会遇到Activity has leaked window.，此时便是出现了窗口泄漏问题。</p>
<p>Android的每一个Activity都有个WindowManager窗体管理器，同样构建在某个Activity之上的对话框、PopupWindow也有相应的WindowManager窗体管理器。因为对话框、PopupWindow不能脱离Activity而单独存在着，所以当某个Dialog或者某个PopupWindow正在显示的时候我们去finish()了承载该Dialog或PopupWindow的 Activity时，就会抛WindowLeaked异常了，因为这个Dialog或PopupWindow的WindowManager已经没有谁可以附属了，所以它的窗体管理器已经泄漏了。</p>
<p><strong>使用isInEditMode解决可视化编辑器无法识别自定义控件的问题</strong></p>
<blockquote>
<p>isInEditMode:<br>Indicates whether this View is currentlyin edit mode. A View is usually in edit mode when displayed within a developertool. For instance, if this View is being drawn by a visual user interfacebuilder, this method should return true. Subclasses should check the returnvalue of this method to provide different behaviors if their normal behaviormight interfere with the host environment. For instance: the class spawns athread in its constructor, the drawing code relies on device-specific features,etc. This method is usually checked in the drawing code of custom widgets.</p>
</blockquote>
<p>所以可以在自定义view的初始化或者需要加载界面的地方设置此方法，避免导致窗体泄漏的问题。</p>
<pre><code><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>{
  <span class="keyword">if</span> (isInEditMode()) {
    <span class="keyword">return</span>;
  }
  <span class="comment">//初始化代码</span>
}
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-Android自动换行ViewGroup" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/08/Android自动换行ViewGroup/" class="article-date">
  	<time datetime="2015-08-08T07:36:13.000Z" itemprop="datePublished">2015-08-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/08/Android自动换行ViewGroup/">Android自动换行ViewGroup</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在Android开发过程中经常会碰到需要让某一些控件，比如：Textview作为标签，而这些标签还要能够自适应屏幕，即要求能够超过一行的宽度时自动换到下一行。Android本身是没有这个控件的。实现起来也不是很难。下面描述一下如何实现这个viewGroup。</p>
<p>首先，我们需要知道控件内部的子view的三个属性：<strong>横向间距</strong>、<strong>纵向间距</strong>、<strong>子view方向(orientation)</strong>。需要先设置控件属性。代码如下：</p>
<pre><code><span class="tag">&lt;<span class="title">declare-styleable</span> <span class="attribute">name</span>=<span class="value">"FlowLayout"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">attr</span> <span class="attribute">name</span>=<span class="value">"horizontalSpacing"</span> <span class="attribute">format</span>=<span class="value">"dimension"</span> /&gt;</span>
    <span class="tag">&lt;<span class="title">attr</span> <span class="attribute">name</span>=<span class="value">"verticalSpacing"</span> <span class="attribute">format</span>=<span class="value">"dimension"</span> /&gt;</span>
    <span class="tag">&lt;<span class="title">attr</span> <span class="attribute">name</span>=<span class="value">"orientation"</span> <span class="attribute">format</span>=<span class="value">"enum"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">enum</span> <span class="attribute">name</span>=<span class="value">"horizontal"</span> <span class="attribute">value</span>=<span class="value">"0"</span> /&gt;</span>
        <span class="tag">&lt;<span class="title">enum</span> <span class="attribute">name</span>=<span class="value">"vertical"</span> <span class="attribute">value</span>=<span class="value">"1"</span> /&gt;</span>
    <span class="tag">&lt;/<span class="title">attr</span>&gt;</span>
<span class="tag">&lt;/<span class="title">declare-styleable</span>&gt;</span>
</code></pre><p>在构造方法中获取到这些属性，留着之后使用：</p>
<pre><code>TypedArray <span class="literal">a</span> = context.obtainStyledAttributes(attributeSet, R.styleable.FlowLayout)<span class="comment">;</span>
horizontalSpacing = <span class="literal">a</span>.getDimensionPixelSize(R.styleable.FlowLayout_horizontalSpacing, <span class="number">0</span>)<span class="comment">;</span>
verticalSpacing = <span class="literal">a</span>.getDimensionPixelSize(R.styleable.FlowLayout_verticalSpacing, <span class="number">0</span>)<span class="comment">;</span>
orientation = <span class="literal">a</span>.getInteger(R.styleable.FlowLayout_orientation, HORIZONTAL)<span class="comment">;</span>
</code></pre><p>之后要使用到<strong>onMeasure()</strong>方法给控件设置宽高大小。</p>
<pre><code><span class="keyword">int</span> sizeWidth = MeasureSpec.getSize(widthMeasureSpec) - <span class="keyword">this</span>.getPaddingRight() - <span class="keyword">this</span>.getPaddingLeft();
<span class="keyword">int</span> sizeHeight = MeasureSpec.getSize(heightMeasureSpec) - <span class="keyword">this</span>.getPaddingTop() - <span class="keyword">this</span>.getPaddingBottom();
<span class="comment">//分别获取到横向和竖向的specMode</span>
<span class="keyword">int</span> modeWidth = MeasureSpec.getMode(widthMeasureSpec);
<span class="keyword">int</span> modeHeight = MeasureSpec.getMode(heightMeasureSpec);
</code></pre><p>因为控件本身可以横向放置也可以纵向放置，所以需要对横纵方向的mode都做处理。如果是横向放置就要使用横向的mode，反之亦然。</p>
<pre><code><span class="title">if</span> (orientation == HORIZONTAL) {
    <span class="title">size</span> = sizeWidth;
    <span class="title">mode</span> = modeWidth;
} <span class="title">else</span> {
    <span class="title">size</span> = sizeHeight;
    <span class="title">mode</span> = modeHeight;
}
</code></pre><p>其中<strong>size</strong>表示整个控件的大小。</p>
<p>之后便是给子view进行位置的确定。也是需要先获取所有的子view并且调用子view的measure方法设置子view的实际宽高。</p>
<pre><code>final View child = getChildAt<span class="params">(i)</span>;
<span class="keyword">if</span> <span class="params">(child.getVisibility<span class="params">()</span> == GONE)</span> {
    continue;
}
LayoutParams lp = <span class="params">(LayoutParams)</span> child.getLayoutParams<span class="params">()</span>;
child.measure<span class="params">(
   getChildMeasureSpec<span class="params">(widthMeasureSpec, this.getPaddingLeft<span class="params">()</span> + this.getPaddingRight<span class="params">()</span>, lp.width)</span>,
   getChildMeasureSpec<span class="params">(heightMeasureSpec, this.getPaddingTop<span class="params">()</span> + this.getPaddingBottom<span class="params">()</span>, lp.height)</span>
)</span>;
</code></pre><p>此时就需要使用到之前属性设置的子view横向和纵向的间距以及子view的宽高</p>
<pre><code><span class="keyword">int</span> hSpacing = <span class="keyword">this</span>.getHorizontalSpacing(lp);
<span class="keyword">int</span> vSpacing = <span class="keyword">this</span>.getVerticalSpacing(lp);
<span class="keyword">int</span> childWidth = child.getMeasuredWidth();
<span class="keyword">int</span> childHeight = child.getMeasuredHeight();
</code></pre><p>此时在循环中要进行计算，如果当前子view的边界再加上边距和下一个子view的宽或者高超出单行的宽度值时则需要进行换行。</p>
<pre><code><span class="title">int</span> childLength;
<span class="title">int</span> childThickness;
<span class="title">int</span> spacingLength;
<span class="title">int</span> spacingThickness;

<span class="title">if</span> (orientation == HORIZONTAL) {
    <span class="title">childLength</span> = childWidth;
    <span class="title">childThickness</span> = childHeight;
    <span class="title">spacingLength</span> = hSpacing;
    <span class="title">spacingThickness</span> = vSpacing;
} <span class="title">else</span> {
    <span class="title">childLength</span> = childHeight;
    <span class="title">childThickness</span> = childWidth;
    <span class="title">spacingLength</span> = vSpacing;
    <span class="title">spacingThickness</span> = hSpacing;
}

<span class="title">lineLength</span> = lineLengthWithSpacing + childLength;
<span class="title">lineLengthWithSpacing</span> = lineLength + spacingLength;

<span class="title">boolean</span> newLine = lp.newLine || (mode != MeasureSpec.UNSPECIFIED &amp;&amp; lineLength &gt; size);
<span class="title">if</span> (newLine) {
    <span class="title">prevLinePosition</span> = prevLinePosition + lineThicknessWithSpacing;

    <span class="title">lineThickness</span> = childThickness;
    <span class="title">lineLength</span> = childLength;
    <span class="title">lineThicknessWithSpacing</span> = childThickness + spacingThickness;
    <span class="title">lineLengthWithSpacing</span> = lineLength + spacingLength;
}

<span class="title">lineThicknessWithSpacing</span> = Math.max(lineThicknessWithSpacing, childThickness + spacingThickness);
<span class="title">lineThickness</span> = Math.max(lineThickness, childThickness);
</code></pre><p>之后便是给自定义view设置起始位置</p>
<pre><code><span class="built_in">int</span> posX;
<span class="built_in">int</span> posY;
<span class="keyword">if</span> (orientation == <span class="type">HORIZONTAL</span>) {
    posX = getPaddingLeft<span class="literal">()</span> + lineLength - childLength;
    posY = getPaddingTop<span class="literal">()</span> + prevLinePosition;
} <span class="keyword">else</span> {
    posX = getPaddingLeft<span class="literal">()</span> + prevLinePosition;
    posY = getPaddingTop<span class="literal">()</span> + lineLength - childHeight;
}
lp.setPosition(posX, posY);
</code></pre><p>此时已经可以给控件和子view设置好宽高和所要放置的相应位置。紧接着需要调用<strong>onLayout()</strong>方法，此时如果需要让控件左对齐显示则直接使用之前设置好的位置便可以，代码如下</p>
<pre><code>final int count = getChildCount<span class="list">()</span><span class="comment">;</span>
for <span class="list">(<span class="keyword">int</span> i = <span class="number">0</span><span class="comment">; i &lt; count; i++) {</span>
    View child = getChildAt<span class="list">(<span class="keyword">i</span>)</span><span class="comment">;</span>
    LayoutParams lp = <span class="list">(<span class="keyword">LayoutParams</span>)</span> child.getLayoutParams<span class="list">()</span><span class="comment">;</span>
    child.layout<span class="list">(<span class="keyword">lp</span>.x, lp.y, lp.x + child.getMeasuredWidth<span class="list">()</span>, lp.y + child.getMeasuredHeight<span class="list">()</span>)</span><span class="comment">;</span>
}</span>
</code></pre><p>而如果当前使用到的标签需要居中显示，则需要对每行的控件获取到并且判断当前行左对齐放置时距右边的边距。此时将右边距除以二，再将当前行第一个子view的左起位置替换则可以达到Group中的子view居中效果。</p>
<p>此时则需要两次循环，一次获取单行的居中时距左边边距，一次进行控件的摆放，代码如下：</p>
<pre><code>final int count = getChildCount<span class="list">()</span><span class="comment">;</span>
int tmpY = <span class="number">0</span><span class="comment">;</span>
int tmpX = <span class="number">0</span><span class="comment">;</span>
for <span class="list">(<span class="keyword">int</span> i = <span class="number">0</span><span class="comment">; i &lt; count; i++) {</span>
    View child = getChildAt<span class="list">(<span class="keyword">i</span>)</span><span class="comment">;</span>
    LayoutParams lp = <span class="list">(<span class="keyword">LayoutParams</span>)</span> child.getLayoutParams<span class="list">()</span><span class="comment">;</span>
    if <span class="list">(<span class="keyword">lp</span>.y == tmpY)</span> {
        tmpX = lp.x + child.getMeasuredWidth<span class="list">()</span><span class="comment">;</span>
    } else {
        tmpY = lp.y<span class="comment">;</span>
        int temp = <span class="list">(<span class="keyword">ScreenUtils</span>.getScreenWidth<span class="list">()</span> - tmpX)</span> / <span class="number">2</span> - <span class="number">5</span><span class="comment">;</span>
        DebugLog.d<span class="list">(<span class="string">"temp:"</span> + temp)</span><span class="comment">;</span>
        startX.add<span class="list">(<span class="keyword">temp</span>)</span><span class="comment">;</span>
    }
    if <span class="list">(<span class="keyword">i</span> == count - <span class="number">1</span>)</span> {
        tmpX = lp.x + child.getMeasuredWidth<span class="list">()</span><span class="comment">;</span>
        int temp = <span class="list">(<span class="keyword">ScreenUtils</span>.getScreenWidth<span class="list">()</span> - tmpX)</span> / <span class="number">2</span><span class="comment">;</span>
        startX.add<span class="list">(<span class="keyword">temp</span>)</span><span class="comment">;</span>
    }
}

int position = <span class="number">0</span><span class="comment">;</span>
int tmpY2 = <span class="number">0</span><span class="comment">;</span>
for <span class="list">(<span class="keyword">int</span> i = <span class="number">0</span><span class="comment">; i &lt; count; i++) {</span>
    View child = getChildAt<span class="list">(<span class="keyword">i</span>)</span><span class="comment">;</span>
    LayoutParams lp = <span class="list">(<span class="keyword">LayoutParams</span>)</span> child.getLayoutParams<span class="list">()</span><span class="comment">;</span>
    if <span class="list">(<span class="keyword">lp</span>.y == <span class="number">0</span>)</span> position = <span class="number">0</span><span class="comment">;</span>
    if <span class="list">(<span class="keyword">tmpY2</span> &lt; lp.y)</span> {
        position++<span class="comment">;</span>
        tmpY2 = lp.y<span class="comment">;</span>
    }
    child.layout<span class="list">(<span class="keyword">startX</span>.get<span class="list">(<span class="keyword">position</span>)</span> + lp.x, lp.y, startX.get<span class="list">(<span class="keyword">position</span>)</span> + lp.x + child.getMeasuredWidth<span class="list">()</span>,
            lp.y + child.getMeasuredHeight<span class="list">()</span>)</span><span class="comment">;</span>
}</span></span>
</code></pre><p>这样便完成了对自定义换行viewGroup的实现。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/08/hello-world/" class="article-date">
  	<time datetime="2015-08-08T02:30:29.740Z" itemprop="datePublished">2015-08-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/08/hello-world/">Hello World</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 Rodriguez-Xin
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>